# CI/CD и деплой Spondex

Этот документ описывает, как настраивается автоматический деплой приложения на удалённый сервер Debian 13 с помощью GitHub Actions и Ansible. Пайплайн разворачивает Docker окружение, синхронизирует исходники и запускает `docker compose` на сервере при каждом `git push`. Ansible устанавливается **только** на GitHub runner; на сервере среды не нужно — он выполняет роли "управляемого хоста".

## Что делает плейбук

Ansible-плейбук `ansible/deploy.yml` выполняет следующие шаги:

1. Проверяет наличие Python 3 на целевой машине.
2. Устанавливает системные пакеты, подключает репозиторий Docker и ставит `docker-ce` вместе с Compose plugin.
3. Синхронизирует проект в `/opt/spondex` (путь задаётся переменной `app_root`).
4. Рендерит `.env` из шаблона и содержимого локального файла (или секрета GitHub, если плейбук запускается в CI).
5. При локальном запуске копирует файл `.cache` из репозитория; при запуске в CI может использовать значение секрета `SPOTIFY_CACHE_CONTENT`. После старта контейнера кэш дополнительно прокидывается внутрь `app`.
6. Поднимает `postgres` с томом `spondex_postgres_data`: если том отсутствует или в экземпляре Postgres нет БД `POSTGRES_DB`, плейбук создаёт её и накатывает `src/create_tables.sql`.
7. В CI авторизуется в GHCR и выполняет `docker compose pull`. При локальном запуске создаёт amd64-образ командой `docker buildx build --load`, переносит его на сервер и выполняет `docker compose up -d --remove-orphans`.

## Требования к серверу

- Debian 13 (или совместимый дистрибутив с `apt`).
- Пользователь с правами `sudo` без запроса пароля (используется для установки пакетов и управления Docker).
- SSH доступ по порту `49384`.
- Включённый UFW (если есть) должен разрешать SSH на этом порту.

## Шаги настройки

### 1. Генерация deploy-ключа

#### Вариант через `ssh-keygen`

На локальной машине выполните:

```bash
ssh-keygen -t ed25519 -C "spondex-deploy" -f ~/.ssh/spondex_deploy
```

- Файл `~/.ssh/spondex_deploy` — приватный ключ (добавим в секреты GitHub).
- Файл `~/.ssh/spondex_deploy.pub` — публичный ключ (добавим на сервер).

#### Вариант через GitHub UI

1. Откройте `Settings → SSH and GPG keys → New SSH key`.
2. Вставьте публичный ключ (`*.pub`) в поле и задайте описание (например, `spondex-deploy`).
3. Нажмите **Add SSH key** — теперь ключ будет доступен для использования GitHub Actions.

### 2. Добавление ключа на сервер

Скопируйте содержимое `spondex_deploy.pub` в файл `~/.ssh/authorized_keys` пользователя `github` (или другого выбранного сервисного пользователя), от имени которого будет запускаться деплой. Убедитесь, что SSH-сервер слушает порт `49384` и что UFW разрешает входящие соединения на этот порт.

### 3. Подготовка файлов окружения

- Скопируйте шаблон `cp .env.example .env` и при необходимости измените параметры PostgreSQL, `APP_PORT`, `EXTRA_UFW_PORTS` и другие не секретные настройки.
- Скопируйте `tokens.env.example` в `tokens.env` (или работайте сразу с `.env`) и заполните чувствительные данные в формате `KEY="value"` — сюда входят `SPOTIPY_CLIENT_ID`, `SPOTIPY_CLIENT_SECRET`, `YANDEX_TOKEN` и другие секреты. При локальном запуске плейбук читает содержимое `.env`, поэтому убедитесь, что там присутствуют все необходимые значения.
- Если деплой выполняется через GitHub Actions, сохраните **полное содержимое** `tokens.env` (или `.env`) в секрете `APP_TOKENS`. GitHub корректно хранит многострочные значения.

Файлы `.env` и `tokens.env` внесены в `.gitignore`, поэтому они не попадут в репозиторий. Секрет `APP_TOKENS` разворачивается плейбуком на сервере непосредственно перед запуском контейнеров.

### 4. Создание секретов GitHub

В настройках репозитория (`Settings → Secrets and variables → Actions`) добавьте следующие секреты:

| Секрет | Назначение |
| --- | --- |
| `SSH_HOST` | IP или доменное имя сервера. |
| `SSH_USER` | SSH-пользователь (например, `github`) с правами sudo без пароля. |
| `SSH_PRIVATE_KEY` | Приватный ключ из `~/.ssh/spondex_deploy` (вставить текст целиком). |
| `APP_TOKENS` | Многострочное содержимое `tokens.env`/`.env` с чувствительными токенами. |
| `SPOTIFY_CACHE_CONTENT` | (Опционально) содержимое файла `.cache` из Spotipy; нужно только если деплой идёт из CI без доступа к локальному файлу. |
| `GHCR_PAT` | Personal Access Token с правами `read:packages` для скачивания образа из GHCR. |

> Настройки `APP_PORT` и `EXTRA_UFW_PORTS` задаются в `.env` (есть дефолты). При необходимости их можно переопределить через inventory/extra-vars при запуске плейбука.

> ⚠️ Убедитесь, что `SSH_PRIVATE_KEY` имеет права только на деплой (при желании ограничьте команды с помощью `authorized_keys`).

### 5. Проверка доступа по SSH из GitHub

Локально убедитесь, что можете подключиться ключом:

```bash
ssh -p 49384 -i ~/.ssh/spondex_deploy <user>@<host>
```

Если всё ок, добавьте хост в `known_hosts` внутри GitHub-секрета (или позвольте workflow сделать это автоматически).

## Запуск пайплайна

Workflow `Build and Publish Docker Image` (`.github/workflows/docker-image.yml`) собирает образ и выкладывает его в GitHub Container Registry (`ghcr.io/<owner>/spondex`). Он запускается при каждом push в `main` и помечает образ тегами `latest`, именем ветки и SHA.

Workflow `Deploy to Production` (`.github/workflows/deploy.yml`) выполняется **при любом push** в репозиторий. Он:

1. Проверяет репозиторий и устанавливает Ansible.
2. Настраивает SSH (используя секреты `SSH_PRIVATE_KEY`, `SSH_HOST`, `SSH_USER`), формирует inventory с портом `49384`.
3. Формирует файл с дополнительными переменными и запускает `ansible/deploy.yml`, который тянет образ из GHCR и разворачивает `docker-compose.prod.yml`.

### Ручной запуск

Для локального деплоя без GitHub Actions достаточно:

```bash
uv tool install ansible
ansible-galaxy collection install -r ansible/requirements.yml
printf '[prod]\n%s ansible_port=49384\n' <host> > /tmp/inventory.ini
ANSIBLE_HOST_KEY_CHECKING=false \
ansible-playbook ansible/deploy.yml \
  -i /tmp/inventory.ini \
  --limit prod \
  -u <user> \
  --private-key ~/.ssh/spondex_deploy \
  --extra-vars "is_ci_environment=true"
```

Плейбук автоматически прочитает содержимое `.env` и `.cache`, если они лежат рядом с репозиторием. Флаг `is_ci_environment=true` отключает локальную сборку Docker-образа и заставляет плейбук тянуть контейнер из GHCR (удобно при запуске с macOS, где `docker buildx --load` может упасть на стадии `uv sync`). При необходимости можно переопределить путь к образу, портам и т.д. через `--extra-vars`.

По умолчанию плейбук синхронизирует весь проект в `/opt/spondex`. При необходимости можно переопределить переменную `app_root` через `--extra-vars`.

## Дополнительные заметки

- Файл `.cache` с токеном Spotify не синхронизируется через `rsync` и не попадает в Docker-образ. Плейбук копирует его на сервер побочно (из локальной папки или секрета), а затем вручную прокидывает внутрь контейнера и перезапускает сервис `app`.
- PostgreSQL использует именованный том `spondex_postgres_data`. При первом деплое (или если том удалён) база создаётся заново и инициализируется скриптом `src/create_tables.sql`. Для ручного сброса можно запустить плейбук с `--extra-vars "force_recreate_db=true"` — он остановит стэк, удалит том и создаст чистую БД.
- `.env` на сервере всегда пересобирается из шаблона и содержимого `APP_TOKENS`/локального `.env`, поэтому правки, сделанные вручную, не сохранятся.
- Продакшен использует `docker-compose.prod.yml` и переменную `SPONDEX_IMAGE`. В CI она указывает на `ghcr.io/<owner>/spondex:latest`, при локальном запуске — на собранный образ `spondex-local:latest`.
- Для авторизации в GHCR по умолчанию используется владелец репозитория (`github.repository_owner`). Если образ размещён в другом аккаунте/организации, задайте переменную Actions `GHCR_IMAGE_OWNER` — она попадёт в плейбук как логин и имя образа.
- При смене SSH-ключа не забудьте обновить секрет `SSH_PRIVATE_KEY` и authorized_keys на сервере.
- Если UFW выключен или отсутствует, задачи по открытию портов будут пропущены.
- Все Docker-команды выполняются от имени `root` через `become: true`. Рекомендуется использовать отдельного системного пользователя с правами sudo: создайте его на сервере, добавьте в sudoers без пароля и настройте ключи.

## GHCR_PAT: зачем нужен и как получить

Пакетный регистр GHCR по умолчанию приватный. Чтобы `docker compose pull` на сервере смог скачать образ `ghcr.io/<owner>/spondex`, GitHub Actions пробрасывает в Ansible персональный токен `GHCR_PAT` с правом `read:packages`.

1. Создайте токен в [настройках GitHub → Developer settings → Personal access tokens → Fine-grained tokens](https://github.com/settings/personal-access-tokens/new). Привяжите его к репозиторию Spondex и отметьте право **Packages → Read**.
2. Сохраните токен в секрете Actions `GHCR_PAT`.
3. При деплое плейбук выполнит `docker login ghcr.io` при помощи этого токена и только затем дернёт `docker compose pull`. Если секрет не задан, плейбук пытается тянуть образ без авторизации — это сработает только для публичных пакетов.

> Токен используется **только** на сервере, данные не попадают в Docker-образ и не сохраняются в репозитории.
