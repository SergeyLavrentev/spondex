# Spondex - музыкальный синхронизатор Yandex Music и Spotify

## Описание

Это приложение синхронизирует любимые треки между сервисами Yandex Music и Spotify. Оно позволяет автоматически добавлять новые треки из одного сервиса в другой, удалять дубликаты и отслеживать треки, которые не удалось найти в одном из сервисов.

## Возможности

- Контролируемая синхронизация треков между Yandex Music и Spotify (по умолчанию только из Spotify в Yandex)
- Автоматическое добавление новых треков
- Удаление дубликатов в обоих сервисах
- Отслеживание ненайденных треков
- Периодическая синхронизация каждые 60 секунд
- Возможность запуска в Docker
- (Бета) Синхронизация плейлистов, избранных альбомов и исполнителей с хранением снимков в PostgreSQL

## Требования

- Python 3.9+
- `pip` (менеджер пакетов Python)
- Аккаунты Yandex Music и Spotify
- Токен Yandex Music
- Зарегистрированное приложение Spotify
- Docker и Docker Compose



## Установка

Клонируйте репозиторий:
```bash
git clone https://github.com/anonymousmaharaj/spondex.git
cd spondex
```
### Предварительная настройка

1. Переименуйте файл `.env.example` в `.env` и заполните его своими (дальше будет описано как).
#### Получение токена Yandex Music

https://yandex-music.readthedocs.io/en/main/token.html

1. Скопируйте полученный токен в переменную YANDEX_TOKEN в файл `.env`.

#### Настройка приложения Spotify

0. Проще всего посмотреть сначала это видео: https://www.youtube.com/watch?v=kaBVN8uP358&t=0s
1. Перейдите на [Spotify Developer Dashboard](https://developer.spotify.com/dashboard/).
2. Создайте новое приложение.
3. Получите `Client ID` и `Client Secret`.
4. Добавьте `http://localhost:8888/callback` в список разрешенных URI для перенаправления.
5. Вставьте полученные данные в файл `.env` в переменные SPOTIPY_CLIENT_ID и SPOTIPY_CLIENT_SECRET.

#### Требуемые разрешения (scopes) Spotify

Приложение запрашивает доступ к следующим областям Spotify Web API:

- `user-library-read`
- `user-library-modify`
- `user-follow-read`
- `user-follow-modify`
- `playlist-read-private`
- `playlist-read-collaborative`

Эти разрешения необходимы для чтения/добавления любимых треков и альбомов, чтения и синхронизации подписок на исполнителей (эндпоинт [Get Followed Artists](https://developer.spotify.com/documentation/web-api/reference/get-followed)), а также для безопасного доступа к приватным и совместным плейлистам.

> ⚠️ При появлении ошибки `403 Insufficient client scope` удалите файл `.cache` в корне проекта и повторите авторизацию через `scripts/start_auth.sh`, чтобы получить новый токен с расширенным набором разрешений.

#### Дополнительные плейлисты Spotify

Spotify API возвращает только те плейлисты, которые вы добавили в свою медиатеку. Если хотите синхронизировать редакторские подборки вроде `Release Radar` или `Discover Weekly`, добавьте их идентификаторы (ID можно скопировать из ссылки «Поделиться») в переменную окружения `SPOTIFY_EXTRA_PLAYLIST_IDS` в `.env`:

```
SPOTIFY_EXTRA_PLAYLIST_IDS=37i9dQZEVXcJZyENOWUFo7,37i9dQZEVXcTkpN9rZqw2r
```

Список обрабатывается через запятую. Эти плейлисты всегда будут подтягиваться и попадать в снимки БД, даже если они не отображаются в `Your Library`.

## Рекомендуемый способ запуска приложения (Docker Compose)

### Полная очистка избранного в Yandex Music

Перед миграцией библиотеки из Spotify может пригодиться "чистый" список любимых треков в Yandex Music. Для этого в репозитории есть сервисный скрипт `scripts/clear_yandex_favorites.py`.

```bash
source .venv/bin/activate
# предварительная проверка количества треков
python scripts/clear_yandex_favorites.py --dry-run
# полная очистка (требует флага подтверждения)
python scripts/clear_yandex_favorites.py --yes
```

Параметры скрипта:

- `--dry-run` — выводит, сколько треков будет удалено, без фактического удаления;
- `--yes` — обязательное подтверждение для реального удаления;
- `--chunk-size N` — задаёт размер батча для API (по умолчанию 100);
- `--verbose` — детальный лог.

⚠️ **Важно:** Скрипт полностью очищает раздел "Мне нравится" в Yandex Music. Действие необратимо, восстановить треки можно только повторным импортом.

### Массовое удаление плейлистов (Yandex Music и Spotify)

Для полной перезагрузки библиотек есть скрипт `scripts/clear_playlists.py`, который умеет очищать плейлисты в Yandex Music и/или Spotify.

```bash
source .venv/bin/activate
# пример: посмотреть, что будет удалено (оба сервиса)
python scripts/clear_playlists.py --dry-run

# только Yandex Music
python scripts/clear_playlists.py --yandex --yes

# только Spotify (оставит чужие плейлисты благодаря --skip-followed)
python scripts/clear_playlists.py --spotify --skip-followed --yes
```

Ключи скрипта:

- `--dry-run` — показать список и количество плейлистов без удаления;
- `--yes` — обязательное подтверждение реального удаления;
- `--yandex` / `--spotify` — выбор целевой платформы (по умолчанию обрабатываются обе);
- `--skip-followed` — для Spotify оставить чужие плейлисты, удаляя только свои;
- `--verbose` — детальный лог.

⚠️ **Важно:**

- Для Spotify требуются права `playlist-read/playlist-modify`; при первом запуске может открыться браузер для повторной авторизации.
- Удаление плейлистов необратимо: вернуть их можно только восстановлением из резервной копии или повторным импортом.

### ВНИМАНИЕ 
```
Основная проблема заключается в том, что первый раз необходимо авторизоваться в Spotify через браузер. По этому первый шаг необходимо выполнить локально на устройстве с браузером.
```
У вас должен быть установлен Python 3.9+ для этого этапа.

1. Выполните аутентификацию Spotify:

   **Linux/macOS**:
   ```bash
   chmod +x scripts/start_auth.sh
   ./scripts/start_auth.sh
   ```

   **Windows**:
   ```
   scripts\start_auth.bat
   ```

   Этот скрипт выполнит следующие действия:
   - Создаст временное окружение, установит зависимости и запустит авторизацию в Spotify
   - Создаст файл `.cache`, в котором будет сохранен ваш токен для Spotify


2. После этого можно запускать приложение в Docker.

   **Linux/macOS**:
   ```bash
   chmod +x scripts/start.sh
   ./scripts/start.sh
   ```

   **Windows**:
   ```
   scripts\start.bat
   ```

Если вы хотите запустить приложение на удаленном сервере, то необходимо скопировать файл `.cache` на сервер в директорию с приложением и запустить скрипт `start.sh` или `start.bat`.

#### Пересборка контейнера приложения

После изменения кода приложения пересоберите образ и перезапустите контейнер:

```bash
docker compose build app
docker compose up -d --no-deps app
```

Команда `docker compose up -d` автоматически соберёт образ при его отсутствии, поэтому достаточно выполнять эти шаги только после обновлений исходников.

### Параметры запуска

Параметры запуска передаются в виде аргументов скрипту, например:
```bash
./scripts/start.sh --sleep 120 --force-full-sync --remove-duplicates
```

Приложение поддерживает следующие параметры командной строки:

- `--sleep SECONDS` — интервал между синхронизациями в секундах (по умолчанию 60)
- `--force-full-sync` — принудительная полная синхронизация всех треков
- `--track-sync-target {both,spotify,yandex}` — выбрать направление синхронизации треков (по умолчанию только добавление в Yandex)
- `--remove-duplicates` — удаление дубликатов после первой синхронизации
- `--sync-playlists` — собрать актуальные плейлисты обеих платформ, сохранить их структуру в БД и добавить недостающие плейлисты/треки из Spotify в Yandex (без удаления)
- `--include-followed-playlists` — вместе с личными плейлистами добавлять подписанные (используется с `--sync-playlists`)
- `--sync-favorite-albums` — синхронизировать избранные альбомы между сервисами (добавляет недостающие согласно целевой платформе)
- `--sync-favorite-artists` — синхронизировать избранных исполнителей между сервисами
- `--favorite-sync-readonly` — вести только снимки в БД без изменений в Spotify/Yandex
- `--favorite-sync-target {both,spotify,yandex}` — выбрать, какая платформа получает недостающие избранные элементы (по умолчанию Yandex)

> ⚠️ **Бета:** режим синхронизации избранных альбомов и исполнителей добавляет недостающие элементы в целевые сервисы, но не удаляет существующие в Yandex Music. Для безопасного анализа воспользуйтесь `--favorite-sync-readonly`.

### Сбор метаданных плейлистов и избранного (бета)

Новые флаги `--sync-playlists`, `--sync-favorite-albums`, `--sync-favorite-artists` сохраняют снимки библиотек в PostgreSQL. Это помогает увидеть расхождения между сервисами и подготовиться к полной двусторонней синхронизации.

- Все необходимые таблицы автоматически создаются при первом запуске контейнера `postgres`, потому что `src/create_tables.sql` подключается как init-скрипт. Если БД уже существует, примените изменения вручную:
   ```bash
   docker compose exec postgres psql \
      -U "$POSTGRES_USER" \
      -d "$POSTGRES_DB" \
      -f /docker-entrypoint-initdb.d/create_tables.sql
   ```
- Данные записываются в таблицы `playlists`, `playlist_tracks`, `favorite_albums`, `favorite_artists`. Для отладки можно запросить свежие записи:
   ```bash
   docker compose exec postgres psql -U "$POSTGRES_USER" -d "$POSTGRES_DB" -c "SELECT name, platform, track_count FROM playlists ORDER BY updated_at DESC LIMIT 10;"
   ```
- Флаг `--include-followed-playlists` добавляет подписанные плейлисты Spotify к снимку (по умолчанию сохраняются только личные).

Плейлисты автоматически создаются (если их ещё нет) и пополняются недостающими треками в Yandex Music. Для избранных альбомов и исполнителей дифф добавляет недостающие элементы в выбранную целевую платформу; по умолчанию данные уезжают только в Yandex. Удаление ни для одного из режимов не выполняется. Чтобы ограничиться аналитикой без изменений, запускайте синк с `--favorite-sync-readonly`.

#### Рекомендуемый сценарий использования

1. **Первый запуск**: используйте оба флага для полной синхронизации и очистки от дубликатов
   ```bash
   ./scripts/start.sh --force-full-sync --remove-duplicates
   ```
   
   Это действие:
   - Игнорирует предыдущие записи о синхронизации
   - Проверяет все треки в обоих сервисах
   - Добавляет недостающие треки в каждый сервис
   - После завершения синхронизации удаляет дубликаты в обоих сервисах

   После завершения первичной синхронизации можно запускать без флагов для инкрементальной синхронизации, остановив приложение командой `docker-compose down` и запустив его снова командой `./scripts/start.sh`.



2. **Обычное использование**: запускайте без флагов для инкрементальной синхронизации
   ```bash
   ./scripts/start.sh
   ```
   
   Приложение будет:
   - Синхронизировать только новые треки, добавленные после последней синхронизации
   - Не удалять дубликаты автоматически
   - Работать более быстро и эффективно

### Генерация зависимостей для Docker и CI

`requirements.txt` формируется автоматически из `pyproject.toml`. Сборка Docker-образа вызывает генерацию автоматически, но для локальной разработки или CI можно запустить скрипт вручную:

```bash
python scripts/generate_requirements.py                # базовые зависимости
python scripts/generate_requirements.py --include-dev  # с dev-зависимостями
```

При необходимости укажите нестандартный путь через `--output path/to/requirements.txt`.

## Ограничения

- Плейлисты пока собираются в режиме только чтения; синхронизация избранных альбомов/исполнителей добавляет недостающие элементы, но не удаляет существующие в Yandex Music.
- Из-за различий в каталогах музыки Yandex Music и Spotify, некоторые треки могут быть не найдены.
- При первом запуске в Docker требуется интерактивная авторизация через браузер.

## Вклад в проект

Если вы хотите внести свой вклад в проект, пожалуйста, создайте issue или отправьте pull request.

## Отказ от ответственности

Это приложение использует неофициальный API Yandex Music. Автор не несет ответственности за возможные последствия использования этого приложения, включая, но не ограничиваясь, блокировкой аккаунта Yandex Music или любые другие проблемы, связанные с использованием неофициального API. Используйте это приложение на свой страх и риск. Тем не менее, приложение разработано с учетом всех известных ограничений и должно работать корректно при нормальном использовании.

## Лицензия

Этот проект распространяется под лицензией MIT. Подробности см. в файле LICENSE.