# Spondex - музыкальный синхронизатор Yandex Music и Spotify

## Описание

Это приложение синхронизирует любимые треки между сервисами Yandex Music и Spotify. Оно позволяет автоматически добавлять новые треки из одного сервиса в другой, удалять дубликаты и отслеживать треки, которые не удалось найти в одном из сервисов.

## Возможности

- Двусторонняя синхронизация между Yandex Music и Spotify
- Автоматическое добавление новых треков
- Удаление дубликатов в обоих сервисах
- Отслеживание ненайденных треков
- Периодическая синхронизация каждые 60 секунд
- Возможность запуска в Docker

## Требования

- Python 3.9+
- `pip` (менеджер пакетов Python), а лучше `uv`
- Аккаунты Yandex Music и Spotify
- Токен Yandex Music
- Зарегистрированное приложение Spotify
- PostgreSQL (при локальном запуске) или Docker и Docker Compose (для контейнеризованного запуска)

## Установка

### Локальная установка

1. Клонируйте репозиторий:
```bash
git clone https://github.com/anonymousmaharaj/spondex.git
cd spondex
```

2. Создайте виртуальное окружение:
   - Если у вас установлен `venv`:
   ```bash
   python -m venv venv
   source venv/bin/activate  # Для Linux/macOS
   venv\Scripts\activate  # Для Windows
   ```
   - Если у вас установлен `conda`:
   ```bash
   conda create -n spondex python=3.9
   conda activate spondex
   ```

3. Установите зависимости:
```bash
pip install uv && uv pip install -r requirements.txt # Для Linux/macOS/Windows
```

4. Создайте файл `.env` в корневой директории проекта (на основе `.env.example`):
```
YANDEX_TOKEN=ваш_токен_yandex_music
SPOTIPY_CLIENT_ID=ваш_client_id_spotify
SPOTIPY_CLIENT_SECRET=ваш_client_secret_spotify
SPOTIPY_REDIRECT_URI=http://localhost:8888/callback
POSTGRES_DB=music_sync
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
```

## Настройка

### Получение токена Yandex Music

https://yandex-music.readthedocs.io/en/main/token.html

### Настройка приложения Spotify

0. Проще всего посмотреть сначала это видео: https://www.youtube.com/watch?v=kaBVN8uP358&t=0s
1. Перейдите на [Spotify Developer Dashboard](https://developer.spotify.com/dashboard/).
2. Создайте новое приложение.
3. Получите `Client ID` и `Client Secret`.
4. Добавьте `http://localhost:8888/callback` в список разрешенных URI для перенаправления.
5. Вставьте полученные данные в файл `.env`.

### Настройка базы данных PostgreSQL

1. Установите PostgreSQL, если он еще не установлен
2. Создайте базу данных:
```sql
CREATE DATABASE music_sync;
```
3. Запустите скрипт создания таблиц:
```bash
psql -U postgres -d music_sync -f create_tables.sql
```

## Использование

### Запуск локально

Запустите приложение командой:
```bash
python src/main.py --sleep 120 --force-full-sync --remove-duplicates
```

При первом запуске вам потребуется авторизоваться в Spotify. После этого в корне проекта появится файл `.cache`, в котором будет сохранен ваш токен.

#### Параметры запуска

Приложение поддерживает следующие параметры командной строки:

- `--sleep SECONDS` — интервал между синхронизациями в секундах (по умолчанию 60)
- `--force-full-sync` — принудительная полная синхронизация всех треков
- `--remove-duplicates` — удаление дубликатов после первой синхронизации

#### Рекомендуемый сценарий использования

1. **Первый запуск**: используйте оба флага для полной синхронизации и очистки от дубликатов
   ```bash
   python main.py --force-full-sync --remove-duplicates
   ```
   
   Это действие:
   - Игнорирует предыдущие записи о синхронизации
   - Проверяет все треки в обоих сервисах
   - Добавляет недостающие треки в каждый сервис
   - После завершения синхронизации удаляет дубликаты в обоих сервисах

2. **Обычное использование**: запускайте без флагов для инкрементальной синхронизации
   ```bash
   python main.py
   ```
   
   Приложение будет:
   - Синхронизировать только новые треки, добавленные после последней синхронизации
   - Не удалять дубликаты автоматически
   - Работать более быстро и эффективно

3. **Периодическая полная проверка**: раз в несколько недель можно запускать полную синхронизацию
   ```bash
   python main.py --force-full-sync
   ```
   
   Это полезно, если:
   - Вы подозреваете, что какие-то треки могли быть пропущены
   - Хотите проверить все треки заново
   - Интегрируете новый сервис или обновляете базу данных

#### Примечания по использованию флагов

- **--force-full-sync**:
  - Игнорирует временные метки последней синхронизации
  - Проверяет каждый трек в обоих сервисах
  - Занимает больше времени, особенно при большой библиотеке
  - Потребляет больше API-запросов к сервисам

- **--remove-duplicates**:
  - Работает только после завершения первой синхронизации
  - Находит треки с одинаковыми названиями и исполнителями
  - Удаляет лишние копии из обоих сервисов
  - Полезно запускать периодически, так как в процессе использования сервисов могут появляться дубликаты

После первой синхронизации перезапустите приложение без флага `--force-full-sync` для более быстрой работы.

### Запуск с помощью Docker

Для запуска приложения в Docker:

1. Создайте файл `.env` на основе `.env.example` и укажите свои учетные данные:
   ```bash
   cp .env.example .env
   nano .env  # или любой другой текстовый редактор
   ```

2. Выполните аутентификацию Spotify (требуется браузер):

   **Linux/macOS**:
   ```bash
   chmod +x scripts/start_auth.sh
   ./scripts/start_auth.sh
   ```

   **Windows**:
   ```
   scripts\start_auth.bat
   ```

3. Запустите приложение в Docker:

   **Linux/macOS**:
   ```bash
   chmod +x scripts/start.sh
   ./scripts/start.sh
   ```

   **Windows**:
   ```
   scripts\start.bat
   ```

Скрипты выполнят следующие действия:
- `start_auth.sh` / `start_auth.bat`: создаст временное окружение, установит зависимости и запустит авторизацию в Spotify
- `start.sh` / `start.bat`: проверит наличие необходимых файлов и запустит приложение в Docker

После успешного запуска, приложение будет доступно и начнет автоматическую синхронизацию.

#### Параметры запуска в Docker

По умолчанию в Docker приложение запускается без дополнительных параметров. Для изменения поведения вы можете отредактировать команду в Dockerfile:

```bash
# Открыть Dockerfile
nano Dockerfile
```

Измените последнюю строку CMD для добавления нужных параметров:

```
CMD ["python", "src/main.py", "--force-full-sync", "--remove-duplicates"]
```

Или вы можете переопределить команду в docker-compose.yml:

```yaml
services:
  app:
    # ... другие настройки ...
    command: python src/main.py --force-full-sync --remove-duplicates
```

После изменения конфигурации перезапустите контейнеры:

```bash
docker-compose down
docker-compose up -d
```

#### Дополнительные команды Docker

Для просмотра логов:
```bash
docker-compose logs -f app
```

Для остановки:
```bash
docker-compose down
```

Для перезапуска:
```bash
docker-compose restart app
```

### Для серверов без браузера

Если вы запускаете приложение на сервере без графического интерфейса:

1. Выполните аутентификацию на локальной машине с браузером с помощью `start_auth.sh` / `start_auth.bat`
2. Скопируйте полученный файл `.cache` на сервер в директорию с приложением
3. Запустите приложение на сервере с помощью `start.sh` / `start.bat`

## Структура базы данных

Приложение использует PostgreSQL базу данных `music_sync` со следующими таблицами:

1. `tracks`: Хранит информацию о синхронизированных треках.
   - `yandex_id`: Идентификатор трека в Yandex Music
   - `spotify_id`: Идентификатор трека в Spotify
   - `artist`: Имя исполнителя
   - `title`: Название трека

2. `sync_history`: Отслеживает время последней синхронизации для каждого сервиса.
   - `service`: Название сервиса (yandex или spotify)
   - `last_sync`: Время последней синхронизации

3. `undiscovered_tracks`: Хранит информацию о треках, которые не удалось найти в одном из сервисов.
   - `id`: Уникальный идентификатор
   - `service`: Сервис, в котором трек не был найден
   - `artist`: Имя исполнителя
   - `title`: Название трека
   - `created_at`: Время добавления записи

## Логирование

Приложение ведет лог своей работы, который выводится в консоль. При запуске через Docker логи можно просматривать командой `docker-compose logs -f app`.

## Решение проблем

### Проблемы с Docker

1. Если контейнер не запускается, проверьте логи:
   ```bash
   docker-compose logs app
   ```

2. Если возникают проблемы с доступом к файлу `.cache`, проверьте права доступа:
   ```bash
   chmod 644 .cache
   ```

### Проблемы с авторизацией

1. Если возникают ошибки авторизации в Spotify, убедитесь, что вы правильно настроили приложение в Spotify Developer Dashboard и корректно указали данные в файле `.env`.

2. Если треки не синхронизируются с Yandex Music, проверьте правильность токена Yandex Music в файле `.env`.

### Проблемы с синхронизацией

1. Если приложение не находит некоторые треки, проверьте таблицу `undiscovered_tracks` в базе данных. Возможно, потребуется ручное добавление этих треков из-за различий в каталогах музыки.

2. Для полной синхронизации всех треков при последующих запусках используйте флаг `--force-full-sync`.

3. Если в вашей библиотеке появляются дубликаты, запустите приложение с флагом `--remove-duplicates`:
   ```bash
   python main.py --remove-duplicates
   ```
   
   При использовании Docker:
   ```bash
   # Временно изменить команду запуска
   docker-compose stop app
   docker-compose run --rm app python main.py --remove-duplicates
   docker-compose start app
   ```

4. Для полной проверки и очистки библиотеки используйте комбинацию флагов:
   ```bash
   python main.py --force-full-sync --remove-duplicates
   ```
   
   Это особенно полезно, если:
   - Вы долго не запускали синхронизацию
   - Синхронизировали треки другими способами
   - Библиотека содержит много дубликатов
   - Вы заметили пропущенные треки после обычной синхронизации

## Ограничения

- Приложение синхронизирует только любимые треки и не работает с плейлистами.
- Из-за различий в каталогах музыки Yandex Music и Spotify, некоторые треки могут быть не найдены.
- При первом запуске в Docker требуется интерактивная авторизация через браузер.

## Вклад в проект

Если вы хотите внести свой вклад в проект, пожалуйста, создайте issue или отправьте pull request.

## Отказ от ответственности

Это приложение использует неофициальный API Yandex Music. Автор не несет ответственности за возможные последствия использования этого приложения, включая, но не ограничиваясь, блокировкой аккаунта Yandex Music или любые другие проблемы, связанные с использованием неофициального API. Используйте это приложение на свой страх и риск. Тем не менее, приложение разработано с учетом всех известных ограничений и должно работать корректно при нормальном использовании.

## Лицензия

Этот проект распространяется под лицензией MIT. Подробности см. в файле LICENSE.

## Структура проекта

```
spondex/
├── docker-compose.yml    # Конфигурация Docker Compose
├── Dockerfile            # Конфигурация Docker-образа
├── scripts/              # Скрипты для запуска
│   ├── start.sh          # Скрипт запуска в Docker (Linux/macOS)
│   ├── start.bat         # Скрипт запуска в Docker (Windows)
│   ├── start_auth.sh     # Скрипт аутентификации (Linux/macOS)
│   ├── start_auth.bat    # Скрипт аутентификации (Windows)
│   └── spotify_auth.py   # Python-скрипт для авторизации в Spotify
├── src/                  # Исходный код приложения
│   ├── __init__.py       # Файл для обработки директории как пакета Python
│   ├── main.py           # Основной файл приложения
│   ├── base_class.py     # Базовый класс для сервисов
│   ├── database_manager.py # Менеджер базы данных
│   ├── create_tables.sql # SQL-скрипт для создания таблиц
│   └── migrate_data.py   # Скрипт для миграции данных
├── .env                  # Файл с переменными окружения (создается из .env.example)
├── .env.example          # Пример файла с переменными окружения
├── .cache                # Кэш-файл аутентификации Spotify (создается автоматически)
├── requirements.txt      # Зависимости Python
└── README.md             # Документация проекта
```

