---
- name: Verify (minimal installation)
  hosts: all
  become: true
  vars:
    app_root: /opt/spondex
  tasks:
    - name: Read templated monitoring config
      ansible.builtin.slurp:
        src: "{{ app_root }}/monitoring/config.yaml"
      register: monitor_config_initial

    - name: Assert templated header is present
      ansible.builtin.assert:
        that:
          - "'Spondex monitoring configuration' in (monitor_config_initial.content | b64decode)"
        fail_msg: "Templated header missing in monitoring config"

    - name: Simulate manual config override
      ansible.builtin.copy:
        dest: "{{ app_root }}/monitoring/config.yaml"
        mode: "0640"
        content: |
          # manual override
          manual_override: true

    - name: Re-run role without overwrite flag (should preserve manual config)
      ansible.builtin.include_role:
        name: monitoring

    - name: Capture config after preservation run
      ansible.builtin.slurp:
        src: "{{ app_root }}/monitoring/config.yaml"
      register: monitor_config_preserved

    - name: Assert manual override preserved
      ansible.builtin.assert:
        that:
          - "'# manual override' in (monitor_config_preserved.content | b64decode)"
          - "'manual_override: true' in (monitor_config_preserved.content | b64decode)"
        fail_msg: "Manual override was not preserved"

    - name: Re-run role with overwrite flag to restore template
      ansible.builtin.include_role:
        name: monitoring
      vars:
        monitor_overwrite_config: true

    - name: Capture config after overwrite run
      ansible.builtin.slurp:
        src: "{{ app_root }}/monitoring/config.yaml"
      register: monitor_config_overwritten

    - name: Assert overwrite restored template
      ansible.builtin.assert:
        that:
          - "'Spondex monitoring configuration' in (monitor_config_overwritten.content | b64decode)"
          - "'manual_override' not in (monitor_config_overwritten.content | b64decode)"
        fail_msg: "Template was not restored after overwrite"

    - name: Check monitoring timer state
      ansible.builtin.command:
        cmd: systemctl is-active spondex-monitor.timer
      register: timer_state
      changed_when: false

    - name: Assert monitoring timer is active
      ansible.builtin.assert:
        that:
          - timer_state.stdout.strip() == 'active'
        fail_msg: "Monitoring timer is not active"

    - name: Check monitoring service unit exists
      ansible.builtin.stat:
        path: /etc/systemd/system/spondex-monitor.service
      register: service_unit

    - name: Check monitoring timer unit exists
      ansible.builtin.stat:
        path: /etc/systemd/system/spondex-monitor.timer
      register: timer_unit

    - name: Assert monitoring units exist
      ansible.builtin.assert:
        that:
          - service_unit.stat.exists
          - timer_unit.stat.exists
        fail_msg: "Monitoring units were not provisioned"
